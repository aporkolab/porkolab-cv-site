name: Update GitHub Stats

on:
  schedule:
    # Naponta egyszer, reggel 6-kor (UTC)
    - cron: '0 6 * * *'
  workflow_dispatch: # Kézi futtatás is lehetséges

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub Stats
        env:
          GH_TOKEN: ${{ secrets.GH_STATS_TOKEN }}
        run: |
          # GraphQL query a contribution adatokhoz
          CURRENT_YEAR=$(date +%Y)
          LAST_YEAR=$((CURRENT_YEAR - 1))

          # Lekérdezzük a contribution calendar adatokat
          RESPONSE=$(curl -s -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST https://api.github.com/graphql \
            -d '{
              "query": "query { user(login: \"APorkolab\") { contributionsCollection(from: \"'$LAST_YEAR'-01-01T00:00:00Z\", to: \"'$CURRENT_YEAR'-12-31T23:59:59Z\") { contributionCalendar { totalContributions weeks { contributionDays { contributionCount date } } } } repositories(first: 100, ownerAffiliations: OWNER) { totalCount nodes { isPrivate } } } }"
            }')

          # Kinyerjük az adatokat
          TOTAL_REPOS=$(echo "$RESPONSE" | jq '.data.user.repositories.totalCount // 0')
          PUBLIC_REPOS=$(echo "$RESPONSE" | jq '[.data.user.repositories.nodes[] | select(.isPrivate == false)] | length')

          # Contribution számok év szerint
          CONTRIBUTIONS_LAST=$(echo "$RESPONSE" | jq --arg year "$LAST_YEAR" '
            [.data.user.contributionsCollection.contributionCalendar.weeks[].contributionDays[] |
             select(.date | startswith($year)) | .contributionCount] | add // 0')

          CONTRIBUTIONS_THIS=$(echo "$RESPONSE" | jq --arg year "$CURRENT_YEAR" '
            [.data.user.contributionsCollection.contributionCalendar.weeks[].contributionDays[] |
             select(.date | startswith($year)) | .contributionCount] | add // 0')

          # JSON fájl létrehozása
          cat > assets/data/github-stats.json << EOF
          {
            "publicRepos": $PUBLIC_REPOS,
            "totalRepos": $TOTAL_REPOS,
            "contributionsLastYear": $CONTRIBUTIONS_LAST,
            "contributionsThisYear": $CONTRIBUTIONS_THIS,
            "lastYear": $LAST_YEAR,
            "currentYear": $CURRENT_YEAR,
            "updatedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "Stats updated:"
          cat assets/data/github-stats.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/data/github-stats.json
          git diff --quiet --staged || git commit -m "Update GitHub stats [skip ci]"
          git push
