name: Update GitHub Stats

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub Stats
        env:
          GH_TOKEN: ${{ secrets.GH_STATS_TOKEN }}
        run: |
          CURRENT_YEAR=$(date +%Y)
          LAST_YEAR=$((CURRENT_YEAR - 1))

          echo "Fetching stats for $LAST_YEAR and $CURRENT_YEAR..."

          # Get user info
          USER_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/APorkolab")

          echo "User data received"

          PUBLIC_REPOS=$(echo "$USER_DATA" | jq '.public_repos // 0')
          TOTAL_REPOS=$(echo "$USER_DATA" | jq '.public_repos + (.total_private_repos // 0)')

          # Get all repos to count
          REPOS_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/APorkolab/repos?per_page=100&type=all")

          REPO_COUNT=$(echo "$REPOS_DATA" | jq 'length')
          echo "Found $REPO_COUNT repos"

          # Get events for contribution counting
          EVENTS=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/APorkolab/events?per_page=100")

          # Count push events by year
          CONTRIBUTIONS_LAST=$(echo "$EVENTS" | jq --arg year "$LAST_YEAR" \
            '[.[] | select(.type == "PushEvent") | select(.created_at | startswith($year)) | .payload.commits | length] | add // 0')

          CONTRIBUTIONS_THIS=$(echo "$EVENTS" | jq --arg year "$CURRENT_YEAR" \
            '[.[] | select(.type == "PushEvent") | select(.created_at | startswith($year)) | .payload.commits | length] | add // 0')

          echo "Results: Public=$PUBLIC_REPOS, Total=$TOTAL_REPOS, Last=$CONTRIBUTIONS_LAST, This=$CONTRIBUTIONS_THIS"

          # Create JSON file using jq
          mkdir -p assets/data
          jq -n \
            --argjson public "$PUBLIC_REPOS" \
            --argjson total "$TOTAL_REPOS" \
            --argjson last "$CONTRIBUTIONS_LAST" \
            --argjson this "$CONTRIBUTIONS_THIS" \
            --argjson lastYear "$LAST_YEAR" \
            --argjson currentYear "$CURRENT_YEAR" \
            --arg updatedAt "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{publicRepos: $public, totalRepos: $total, contributionsLastYear: $last, contributionsThisYear: $this, lastYear: $lastYear, currentYear: $currentYear, updatedAt: $updatedAt}' \
            > assets/data/github-stats.json

          echo "Generated github-stats.json:"
          cat assets/data/github-stats.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/data/github-stats.json
          git diff --quiet --staged || git commit -m "Update GitHub stats [skip ci]"
          git push
