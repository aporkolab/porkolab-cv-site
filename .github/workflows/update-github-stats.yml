name: Update GitHub Stats

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub Stats via GraphQL
        env:
          GH_TOKEN: ${{ secrets.GH_STATS_TOKEN }}
        run: |
          CURRENT_YEAR=$(date +%Y)
          LAST_YEAR=$((CURRENT_YEAR - 1))

          echo "Fetching contribution data for $LAST_YEAR and $CURRENT_YEAR..."

          # GraphQL query for this year's contributions
          THIS_YEAR_RESPONSE=$(curl -s -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST https://api.github.com/graphql \
            -d "{\"query\": \"query { user(login: \\\"APorkolab\\\") { contributionsCollection(from: \\\"${CURRENT_YEAR}-01-01T00:00:00Z\\\", to: \\\"${CURRENT_YEAR}-12-31T23:59:59Z\\\") { totalCommitContributions contributionCalendar { totalContributions } } repositories(ownerAffiliations: OWNER) { totalCount } repositoriesContributedTo(contributionTypes: COMMIT) { totalCount } } }\"}")

          echo "This year response:"
          echo "$THIS_YEAR_RESPONSE" | jq '.'

          # GraphQL query for last year's contributions
          LAST_YEAR_RESPONSE=$(curl -s -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST https://api.github.com/graphql \
            -d "{\"query\": \"query { user(login: \\\"APorkolab\\\") { contributionsCollection(from: \\\"${LAST_YEAR}-01-01T00:00:00Z\\\", to: \\\"${LAST_YEAR}-12-31T23:59:59Z\\\") { totalCommitContributions contributionCalendar { totalContributions } } } }\"}")

          echo "Last year response:"
          echo "$LAST_YEAR_RESPONSE" | jq '.'

          # Extract data
          TOTAL_REPOS=$(echo "$THIS_YEAR_RESPONSE" | jq '.data.user.repositories.totalCount // 0')

          # Get public repos via REST API (more reliable)
          USER_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/users/APorkolab")
          PUBLIC_REPOS=$(echo "$USER_DATA" | jq '.public_repos // 0')

          # Get contributions (totalContributions includes commits, issues, PRs, reviews)
          CONTRIBUTIONS_THIS=$(echo "$THIS_YEAR_RESPONSE" | jq '.data.user.contributionsCollection.contributionCalendar.totalContributions // 0')
          CONTRIBUTIONS_LAST=$(echo "$LAST_YEAR_RESPONSE" | jq '.data.user.contributionsCollection.contributionCalendar.totalContributions // 0')

          echo ""
          echo "========================================="
          echo "Results:"
          echo "  Public Repos: $PUBLIC_REPOS"
          echo "  Total Repos: $TOTAL_REPOS"
          echo "  Contributions $LAST_YEAR: $CONTRIBUTIONS_LAST"
          echo "  Contributions $CURRENT_YEAR: $CONTRIBUTIONS_THIS"
          echo "========================================="

          # Create JSON file
          mkdir -p assets/data
          jq -n \
            --argjson public "$PUBLIC_REPOS" \
            --argjson total "$TOTAL_REPOS" \
            --argjson last "$CONTRIBUTIONS_LAST" \
            --argjson this "$CONTRIBUTIONS_THIS" \
            --argjson lastYear "$LAST_YEAR" \
            --argjson currentYear "$CURRENT_YEAR" \
            --arg updatedAt "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{publicRepos: $public, totalRepos: $total, contributionsLastYear: $last, contributionsThisYear: $this, lastYear: $lastYear, currentYear: $currentYear, updatedAt: $updatedAt}' \
            > assets/data/github-stats.json

          echo ""
          echo "Generated github-stats.json:"
          cat assets/data/github-stats.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/data/github-stats.json
          git diff --quiet --staged || git commit -m "Update GitHub stats [skip ci]"
          git push
