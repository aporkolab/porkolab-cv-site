name: Update GitHub Stats

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch GitHub Stats
        env:
          GH_TOKEN: ${{ secrets.GH_STATS_TOKEN }}
        run: |
          CURRENT_YEAR=$(date +%Y)
          LAST_YEAR=$((CURRENT_YEAR - 1))

          echo "Fetching stats for $LAST_YEAR and $CURRENT_YEAR..."

          # GraphQL query
          QUERY='query($login: String!, $from: DateTime!, $to: DateTime!) {
            user(login: $login) {
              repositories(first: 100, ownerAffiliations: OWNER) {
                totalCount
                nodes { isPrivate }
              }
              contributionsCollection(from: $from, to: $to) {
                totalCommitContributions
                restrictedContributionsCount
                contributionCalendar {
                  totalContributions
                  weeks {
                    contributionDays {
                      contributionCount
                      date
                    }
                  }
                }
              }
            }
          }'

          # Variables
          VARIABLES=$(cat <<EOF
          {
            "login": "APorkolab",
            "from": "${LAST_YEAR}-01-01T00:00:00Z",
            "to": "${CURRENT_YEAR}-12-31T23:59:59Z"
          }
          EOF
          )

          # Make request
          RESPONSE=$(curl -s -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST https://api.github.com/graphql \
            -d "$(jq -n --arg query "$QUERY" --argjson variables "$VARIABLES" '{query: $query, variables: $variables}')")

          echo "API Response:"
          echo "$RESPONSE" | jq '.'

          # Check for errors
          if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "GraphQL errors detected!"
            echo "$RESPONSE" | jq '.errors'
            exit 1
          fi

          # Extract data
          TOTAL_REPOS=$(echo "$RESPONSE" | jq '.data.user.repositories.totalCount // 0')
          PUBLIC_REPOS=$(echo "$RESPONSE" | jq '[.data.user.repositories.nodes // [] | .[] | select(.isPrivate == false)] | length')

          # Count contributions by year
          CONTRIBUTIONS_LAST=$(echo "$RESPONSE" | jq --arg year "$LAST_YEAR" '
            [.data.user.contributionsCollection.contributionCalendar.weeks // [] | .[] | .contributionDays // [] | .[] |
             select(.date | startswith($year)) | .contributionCount] | add // 0')

          CONTRIBUTIONS_THIS=$(echo "$RESPONSE" | jq --arg year "$CURRENT_YEAR" '
            [.data.user.contributionsCollection.contributionCalendar.weeks // [] | .[] | .contributionDays // [] | .[] |
             select(.date | startswith($year)) | .contributionCount] | add // 0')

          echo "Results: Public=$PUBLIC_REPOS, Total=$TOTAL_REPOS, Last=$CONTRIBUTIONS_LAST, This=$CONTRIBUTIONS_THIS"

          # Create JSON file
          mkdir -p assets/data
          cat > assets/data/github-stats.json << EOF
          {
            "publicRepos": $PUBLIC_REPOS,
            "totalRepos": $TOTAL_REPOS,
            "contributionsLastYear": $CONTRIBUTIONS_LAST,
            "contributionsThisYear": $CONTRIBUTIONS_THIS,
            "lastYear": $LAST_YEAR,
            "currentYear": $CURRENT_YEAR,
            "updatedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "Generated github-stats.json:"
          cat assets/data/github-stats.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add assets/data/github-stats.json
          git diff --quiet --staged || git commit -m "Update GitHub stats [skip ci]"
          git push
